<!-- Paso 1: Selección de planes -->
<div *ngIf="!selectedPlan" class="planes-step">
  <h2>Elige tu plan</h2>
  <div class="plan-list">
    <div class="plan-card" *ngFor="let plan of plans">
      <h3>{{ plan.nickname || plan.product }}</h3>
      <p>
        ${{ plan.price }} {{ plan.currency | uppercase }}
        / {{ plan.interval === 'month' ? 'Mes' : 'Año' }}
      </p>
      <p>{{ plan.description }}</p>
      <button (click)="selectPlan(plan)">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <line x1="5" y1="12" x2="19" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <polyline points="12,5 19,12 12,19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        Seleccionar plan
      </button>
    </div>
  </div>
</div>

<!-- Paso 2: Pasarela de pago y resumen -->
<div *ngIf="selectedPlan">
  <div class="payment-page">
    <!-- Izquierda: formulario de facturación y tarjeta -->
    <div class="payment-left">
      <button type="button" class="back-btn" (click)="goBack()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <line x1="19" y1="12" x2="5" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <polyline points="12,19 5,12 12,5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        Cambiar plan
      </button>

      <h3>Información de facturación</h3>
      <form #billingForm="ngForm" autocomplete="off">
        <div class="billing-row">
          <div>
            <label for="billing-first-name">Nombre de pila</label>
            <input
              id="billing-first-name"
              [(ngModel)]="billing.firstName"
              name="firstName"
              type="text"
              placeholder="Ingresa tu nombre"
              required />
          </div>
          <div>
            <label for="billing-last-name">Apellido</label>
            <input
              id="billing-last-name"
              [(ngModel)]="billing.lastName"
              name="lastName"
              type="text"
              placeholder="Ingresa tu apellido"
              required />
          </div>
        </div>

        <div>
          <label for="billing-country">País o región</label>
          <select id="billing-country" [(ngModel)]="billing.country" name="country" required>
            <option value="MX">México</option>
            <option value="US">Estados Unidos</option>
            <option value="CA">Canadá</option>
            <option value="ES">España</option>
            <option value="AR">Argentina</option>
            <option value="CO">Colombia</option>
            <option value="PE">Perú</option>
            <option value="CL">Chile</option>
          </select>
        </div>

        <div>
          <label for="billing-address1">Primera línea de la dirección</label>
          <input
            id="billing-address1"
            [(ngModel)]="billing.address1"
            name="address1"
            type="text"
            placeholder="Calle y número"
            required />
        </div>

        <div>
          <label for="billing-address2">Segunda línea de la dirección</label>
          <input
            id="billing-address2"
            [(ngModel)]="billing.address2"
            name="address2"
            type="text"
            placeholder="Apartamento, suite, etc. (opcional)" />
        </div>

        <div class="billing-row">
          <div>
            <label for="billing-zip">Código postal</label>
            <input
              id="billing-zip"
              [(ngModel)]="billing.postalCode"
              name="postalCode"
              type="text"
              placeholder="12345"
              required />
          </div>
          <div>
            <label for="billing-city">Ciudad</label>
            <input
              id="billing-city"
              [(ngModel)]="billing.city"
              name="city"
              type="text"
              placeholder="Tu ciudad"
              required />
          </div>
          <div>
            <label for="billing-state">Estado</label>
            <input
              id="billing-state"
              [(ngModel)]="billing.state"
              name="state"
              type="text"
              placeholder="Tu estado"
              required />
          </div>
        </div>
      </form>

      <hr />

      <h3>Datos de tarjeta</h3>
      <div class="card-box">
        <div class="card-field">
          <label for="cardholder-name">Nombre en tarjeta</label>
          <input
            id="cardholder-name"
            type="text"
            placeholder="Nombre como aparece en la tarjeta"
            [(ngModel)]="cardholderName"
            name="cardholderName"
            required />
        </div>

        <div class="card-field">
          <label for="cardholder-email">Email</label>
          <input
            id="cardholder-email"
            type="email"
            placeholder="tu@email.com"
            [(ngModel)]="cardholderEmail"
            name="cardholderEmail"
            required />
        </div>

        <div class="card-field">
          <label for="card-number-element">Número de tarjeta</label>
          <div #cardNumber id="card-number-element" class="card-input"></div>
        </div>

        <div class="card-row">
          <div class="card-col">
            <label for="card-expiry-element">Expiración</label>
            <div #cardExpiry id="card-expiry-element" class="card-input"></div>
          </div>
          <div class="card-col">
            <label for="card-cvc-element">CVC</label>
            <div #cardCvc id="card-cvc-element" class="card-input"></div>
          </div>
        </div>

        <div id="card-result" class="card-result">{{ errorMessage }}</div>

        <button
          type="button"
          class="payment-button"
          [class.loading]="processing"
          [class.success]="success"
          [disabled]="!isFormCompletelyValid() || processing"
          (click)="processPayment()">

          <span *ngIf="!processing && !success" class="button-content">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <rect x="1" y="4" width="22" height="16" rx="2" ry="2" stroke="currentColor" stroke-width="2"/>
              <line x1="1" y1="10" x2="23" y2="10" stroke="currentColor" stroke-width="2"/>
            </svg>
            Pagar ${{ selectedPlan.price }} {{ selectedPlan.currency | uppercase }}
          </span>

          <span *ngIf="processing" class="button-content">
            <div class="spinner"></div>
            Procesando pago...
          </span>

          <span *ngIf="success" class="button-content">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <polyline points="20,6 9,17 4,12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            ¡Pago exitoso!
          </span>
        </button>
      </div>
    </div>

    <!-- Derecha: resumen de compra -->
    <div class="payment-right">
      <h3>Resumen de tu compra</h3>
      <div class="plan-summary">
        <b>{{ selectedPlan.nickname || selectedPlan.product }}</b>
        <div>
          ${{ selectedPlan.price }} {{ selectedPlan.currency | uppercase }}
          / {{ selectedPlan.interval === 'month' ? 'Mes' : 'Año' }}
        </div>
        <div>{{ selectedPlan.description }}</div>
      </div>

      <!-- Información adicional -->
      <div class="security-info">
        <div class="security-item">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <span>Pago seguro con SSL</span>
        </div>
        <div class="security-item">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect x="3" y="11" width="18" height="11" rx="2" ry="2" stroke="currentColor" stroke-width="2"/>
            <circle cx="12" cy="16" r="1" stroke="currentColor" stroke-width="2"/>
            <path d="M7 11V7a5 5 0 0 1 10 0v4" stroke="currentColor" stroke-width="2"/>
          </svg>
          <span>Datos encriptados</span>
        </div>
        <div class="security-item">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <polyline points="22,12 18,12 15,21 9,3 6,12 2,12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <span>Soporte 24/7</span>
        </div>
      </div>
    </div>
  </div>
</div>
